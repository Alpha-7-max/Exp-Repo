<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insight - Your AI Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #030712; 
            color: #D1D5DB; 
            min-height: 100vh; 
            overflow-x: hidden; 
            background-image: radial-gradient(ellipse at top left, rgba(23, 37, 84, 0.5) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(59, 130, 246, 0.3) 0%, transparent 50%);
            margin: 0;
            padding: 0;
        }
        
        .glassmorphic-panel { 
            background: rgba(17, 24, 39, 0.8); 
            backdrop-filter: blur(20px) saturate(180%); 
            -webkit-backdrop-filter: blur(20px) saturate(180%); 
            border: 1px solid rgba(255, 255, 255, 0.12); 
        }
        
        .chat-message-container { 
            flex: 1;
            overflow-y: auto; 
            scroll-behavior: smooth;
            position: relative;
            padding: 0 0.5rem;
        }
        
        .custom-scrollbar {
            position: absolute;
            right: 4px;
            top: 8px;
            bottom: 8px;
            width: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .custom-scrollbar-thumb {
            position: absolute;
            right: 0;
            width: 4px;
            background: rgba(99, 102, 241, 0.6);
            border-radius: 2px;
            transition: background-color 0.3s;
        }
        
        .custom-scrollbar:hover .custom-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.8);
        }
        
        .chat-message-container:hover .custom-scrollbar {
            opacity: 1;
        }
        
        .chat-bubble { 
            max-width: 85%; 
            word-wrap: break-word; 
        }
        
        .user-bubble { 
            background-color: rgba(59, 130, 246, 0.2); 
            border: 1px solid rgba(59, 130, 246, 0.3); 
        }
        
        .ai-bubble { 
            background-color: rgba(30, 41, 59, 0.8); 
            border: 1px solid rgba(55, 65, 81, 1); 
        }
        
        .image-pill { 
            display: inline-flex; 
            align-items: center; 
            background-color: rgba(79, 70, 229, 0.3); 
            border: 1px solid rgba(99, 102, 241, 0.5); 
            border-radius: 9999px; 
            padding: 4px; 
            gap: 6px; 
            font-size: 0.8rem; 
        }
        
        .image-pill img { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            object-fit: cover; 
        }
        
        .image-pill .remove-pill { 
            background: rgba(239, 68, 68, 0.7); 
            border-radius: 50%; 
            width: 18px; 
            height: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: background-color 0.2s; 
        }
        
        .image-pill .remove-pill:hover { 
            background: rgba(220, 38, 38, 1); 
        }
        
        .chat-image-container img { 
            width: 100%; 
            max-width: 400px; 
            height: auto; 
            border-radius: 0.5rem; 
            margin-top: 0.75rem; 
            border: 1px solid rgba(99, 102, 241, 0.3); 
            background-color: #030712; 
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .chat-bubble {
                max-width: 90%;
                font-size: 0.9rem;
            }
            .image-pill {
                font-size: 0.7rem;
                padding: 3px;
            }
            .image-pill img {
                width: 20px;
                height: 20px;
            }
            .chat-image-container img {
                max-width: 100%;
            }
        }
        
        /* CHANGE 1: Removed the media query that added margin on small screens to allow edge-to-edge layout */
    </style>
</head>
<!-- CHANGE 1: Body padding is removed for mobile and applied only for 'sm' screens and up -->
<body class="sm:p-4">

    <!-- CHANGE 1: Height is 100vh on mobile and 95vh on sm+ screens -->
    <main class="w-full max-w-4xl mx-auto flex flex-col h-[100vh] sm:h-[95vh]">
        <div class="flex items-center justify-center mb-4 sm:mb-6 pt-4 sm:pt-0">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.75" stroke="currentColor" class="w-8 h-8 sm:w-9 sm:h-9 text-indigo-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75V15m0-6.75V6" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75v.008" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 12h.008v.008H7.5V12zm9 0h.008v.008H16.5V12z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12a7.5 7.5 0 1115 0 7.5 7.5 0 01-15 0z" fill="currentColor" opacity="0.2" />
            </svg>
            <span class="ml-3 font-bold text-2xl sm:text-3xl text-slate-100" style="font-family: 'Orbitron', sans-serif;">INSIGHT</span>
        </div>
        
        <!-- CHANGE 1: Rounding is removed for mobile (sharp corners) and applied only on sm+ screens -->
        <div class="glassmorphic-panel p-3 sm:p-4 md:p-6 sm:rounded-xl md:rounded-2xl flex-grow flex flex-col min-h-0">
            <div class="chat-message-container space-y-3 sm:space-y-4 flex-grow min-h-0 relative">
                <div class="custom-scrollbar">
                    <div class="custom-scrollbar-thumb"></div>
                </div>
                <div class="flex justify-start">
                    <div class="ai-bubble p-3 rounded-lg">
                        <!-- CHANGE 2: Initial message converted to English -->
                        <p>Hello! I'm Insight, your multi-modal AI partner. You can chat with me, analyze images, or request new ones. How can I help you today?</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-3 sm:mt-4 p-3 bg-slate-800/50 border border-slate-700 rounded-lg">
                <div id="image-pills-container" class="flex flex-wrap gap-2 mb-2"></div>
                <div class="flex items-start gap-2 sm:gap-3">
                    <button id="attach-image-button" class="flex-shrink-0 h-10 w-10 sm:h-12 sm:w-12 bg-indigo-500/20 text-indigo-300 rounded-lg flex items-center justify-center hover:bg-indigo-500/30 transition-colors">
                        <i class="fas fa-paperclip text-lg sm:text-xl"></i>
                    </button>
                    <input type="file" id="image-input" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                    <textarea id="chatInput" class="flex-grow bg-slate-900 border border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none text-sm sm:text-base" placeholder="Type your message..." rows="1"></textarea>
                    <button id="chatSendButton" class="flex-shrink-0 h-10 w-10 sm:h-12 sm:w-12 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-500 transition-colors">
                        <i class="fas fa-paper-plane text-lg sm:text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = "AIzaSyCP0_JSlzsnNKczFe-dBTZyoyKBwvvP6UE"; 
        const MULTIMODAL_MODEL_NAME = "gemini-2.5-flash-preview-04-17";
        const MAX_IMAGES_PER_MSG = 4;

        // NOTE: Master prompt is unchanged, so AI still replies in Roman Urdu as requested.
        const MASTER_PROMPT = `You are 'Insight', a genius-level, multi-modal AI assistant with persistent memory. You will receive the full CHAT_HISTORY, the LATEST_USER_MESSAGE, any NEWLY_UPLOADED_IMAGES, and crucially, the 'ACTIVE_IMAGE_PROMPT' which is the prompt that created the last image in the conversation.

IMPORTANT: You must respond in Roman Urdu (Urdu written in English alphabet) for all conversational text. However, for image generation prompts, you must ALWAYS use English only.

CRITICAL: Your entire output must be ONLY the JSON object and nothing else. Do not add any introductory text, apologies, or explanations outside of the JSON structure.

Your response MUST be in a valid JSON format:
{
  "text_response": "Your conversational reply to the user in Roman Urdu. This should be friendly, natural, and explain what you are doing if generating an image.",
  "image_generation_prompt": "If you decide to generate/edit an image, create a detailed, single-paragraph prompt for a text-to-image AI here IN ENGLISH ONLY. Otherwise, this MUST be null."
}

YOUR DECISION LOGIC:
1.  **If NEWLY_UPLOADED_IMAGES exist:** Your top priority is these new images. The ACTIVE_IMAGE_PROMPT should be ignored.
    - If there is ONE new image and the user asks to edit it (e.g., 'make this girl's dress blue'), create an image prompt describing the edited scene.
    - If there are MULTIPLE new images, the user wants to compose a scene. Create a prompt that combines the subjects from all images as per their text instructions.
    - If the user just asks to analyze ("what is this?"), provide the analysis in 'text_response' and set 'image_generation_prompt' to null.
2.  **If NO new images are attached, BUT 'ACTIVE_IMAGE_PROMPT' exists:** This means the user wants to modify the LAST image you showed them.
    - Your job is to be a PRECISION EDITOR. Surgically modify the 'ACTIVE_IMAGE_PROMPT' with the user's new instructions (e.g., change color, add an item). Do NOT change anything else. The original visual context is paramount.
3.  **If NO new images AND NO 'ACTIVE_IMAGE_PROMPT':** This is a fresh conversation.
    - If the user's message is inherently visual ("show me a picture of Saturn"), create an 'image_generation_prompt'.
    - Otherwise, have a normal text-based conversation, keeping 'image_generation_prompt' as null.

CHAT HISTORY (for context):
{CHAT_HISTORY}

ACTIVE IMAGE PROMPT (from last turn, if any):
{ACTIVE_IMAGE_PROMPT}

LATEST USER MESSAGE:
"{USER_MESSAGE}"`;

        // --- ELEMENT SELECTORS ---
        const chatMessageContainerEl = document.querySelector('.chat-message-container');
        const chatInputEl = document.getElementById('chatInput');
        const chatSendButtonEl = document.getElementById('chatSendButton');
        const attachImageButtonEl = document.getElementById('attach-image-button');
        const imageInputEl = document.getElementById('image-input');
        const imagePillsContainerEl = document.getElementById('image-pills-container');

        // --- STATE VARIABLES ---
        let stagedImages = []; 
        let chatHistory = [];
        let activeImagePrompt = null; 
        let isProcessing = false;

        // --- CUSTOM SCROLLBAR FUNCTIONALITY ---
        function initCustomScrollbar() {
            const container = chatMessageContainerEl;
            const scrollbar = container.querySelector('.custom-scrollbar');
            const thumb = scrollbar.querySelector('.custom-scrollbar-thumb');
            
            function updateScrollbar() {
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;
                const scrollTop = container.scrollTop;
                
                if (scrollHeight <= clientHeight) {
                    scrollbar.style.opacity = '0';
                    return;
                }
                
                const thumbHeight = Math.max(20, (clientHeight / scrollHeight) * clientHeight);
                const thumbTop = (scrollTop / scrollHeight) * clientHeight;
                
                thumb.style.height = thumbHeight + 'px';
                thumb.style.top = thumbTop + 'px';
            }
            
            container.addEventListener('scroll', updateScrollbar);
            window.addEventListener('resize', updateScrollbar);
            updateScrollbar();
        }

        // --- UI & MESSAGE FUNCTIONS ---
        function addChatMessage(message, role, images = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble p-3 rounded-lg ${role === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            if (images.length > 0) {
                const imageGrid = document.createElement('div');
                imageGrid.className = 'flex flex-wrap gap-2 mb-2';
                images.forEach(imgData => {
                    const img = document.createElement('img');
                    img.src = imgData.base64;
                    img.className = 'h-16 w-16 sm:h-20 sm:w-20 object-cover rounded-md';
                    imageGrid.appendChild(img);
                });
                bubble.appendChild(imageGrid);
            }
            
            const textPara = document.createElement('p');
            textPara.innerHTML = message;
            bubble.appendChild(textPara);
            messageDiv.appendChild(bubble);
            chatMessageContainerEl.appendChild(messageDiv);
            chatMessageContainerEl.scrollTop = chatMessageContainerEl.scrollHeight;
            return bubble;
        }

        function showThinkingIndicator() {
            hideThinkingIndicator();
            const indicatorHTML = `
                <div class="flex justify-start" id="dynamic-thinking-indicator">
                    <div class="ai-bubble p-3 rounded-lg">
                        <!-- CHANGE 2: Indicator text converted to English -->
                        <p><i class="fas fa-spinner fa-spin mr-2"></i>Insight is thinking...</p>
                    </div>
                </div>
            `;
            chatMessageContainerEl.insertAdjacentHTML('beforeend', indicatorHTML);
            chatMessageContainerEl.scrollTop = chatMessageContainerEl.scrollHeight;
        }

        function hideThinkingIndicator() {
            const indicator = document.getElementById('dynamic-thinking-indicator');
            if (indicator) indicator.remove();
        }

        function renderImagePills() {
            imagePillsContainerEl.innerHTML = '';
            stagedImages.forEach((imgData, index) => {
                const pill = document.createElement('div');
                pill.className = 'image-pill';
                pill.innerHTML = `<img src="${imgData.base64}" alt="image preview"><span>${imgData.name.substring(0, 8)}...</span><button class="remove-pill" data-index="${index}">Ã—</button>`;
                imagePillsContainerEl.appendChild(pill);
            });
            
            imagePillsContainerEl.querySelectorAll('.remove-pill').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.currentTarget.dataset.index, 10);
                    stagedImages.splice(indexToRemove, 1);
                    renderImagePills();
                });
            });
        }
        
        async function openDownloadPage(imageUrl, prompt, buttonElement) {
            // CHANGE 2: Button text converted to English
            buttonElement.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Preparing...`;
            buttonElement.disabled = true;

            try {
                const response = await fetch(imageUrl);
                if (!response.ok) throw new Error('Failed to fetch image data.');
                const imageBlob = await response.blob();
                const localImageUrl = URL.createObjectURL(imageBlob);
                
                // CHANGE 2: Download page text converted to English
                const downloadPageHtml = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Download Image</title>
                        <style>
                            body { margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: #111827; color: #e5e7eb; font-family: sans-serif; padding: 20px; box-sizing: border-box; text-align: center; }
                            img { max-width: 90%; max-height: 70vh; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
                            .download-btn { display: inline-block; margin-top: 24px; padding: 12px 24px; background-color: #4f46e5; color: white; text-decoration: none; font-weight: bold; border-radius: 8px; transition: background-color 0.2s; }
                            .download-btn:hover { background-color: #4338ca; }
                            .info { margin-top: 12px; font-size: 0.9em; color: #9ca3af; }
                        </style>
                    </head>
                    <body>
                        <h1>Image Preview & Download</h1>
                        <img src="${localImageUrl}" alt="AI Generated Image: ${prompt}">
                        <a href="${localImageUrl}" download="insight-generated-image.png" class="download-btn">Download Image</a>
                        <p class="info">If the button doesn't work, try long-pressing the image and selecting 'Download' or 'Save'.</p>
                    </body>
                    </html>
                `;
                const pageBlob = new Blob([downloadPageHtml], { type: 'text/html' });
                const pageBlobUrl = URL.createObjectURL(pageBlob);
                window.open(pageBlobUrl, '_blank');

            } catch (error) {
                console.error("Download preparation failed:", error);
                // CHANGE 2: Alert text converted to English
                alert("Could not prepare the image for download. Please try again.");
            } finally {
                // CHANGE 2: Button text converted to English
                buttonElement.innerHTML = `<i class="fas fa-external-link-alt mr-2"></i>Open & Save`;
                buttonElement.disabled = false;
            }
        }

        // --- CORE LOGIC ---
        async function handleChatSubmit() {
            const userMessage = chatInputEl.value.trim();
            if ((!userMessage && stagedImages.length === 0) || isProcessing) return;

            const imagesForThisMessage = [...stagedImages];
            addChatMessage(userMessage, 'user', imagesForThisMessage);
            chatHistory.push({ role: 'user', content: userMessage });
            
            chatInputEl.value = '';
            stagedImages = [];
            renderImagePills();
            autoResizeTextarea();

            isProcessing = true;
            showThinkingIndicator();
            
            try {
                if (imagesForThisMessage.length > 0) { activeImagePrompt = null; }

                const historyString = chatHistory.map(m => `${m.role}: ${m.content}`).join('\\n');
                const prompt = MASTER_PROMPT
                    .replace("{CHAT_HISTORY}", historyString)
                    .replace("{ACTIVE_IMAGE_PROMPT}", activeImagePrompt || "None")
                    .replace("{USER_MESSAGE}", userMessage);
                
                const parts = [{ text: prompt }];
                imagesForThisMessage.forEach(img => {
                    parts.push({ inline_data: { mime_type: img.mime_type, data: img.base64.split(',')[1] } });
                });

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MULTIMODAL_MODEL_NAME}:generateContent?key=${API_KEY}`;
                const requestBody = { contents: [{ parts }], generationConfig: { temperature: 0.5, topP: 1, topK: 32, maxOutputTokens: 2048 } };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                const responseData = await response.json();
                
                hideThinkingIndicator();

                if (!response.ok) throw new Error(responseData.error?.message || "API request failed");
                
                let rawAiResponseText = responseData.candidates[0].content.parts[0].text;
                
                let aiResponse;
                try {
                    const cleanedText = rawAiResponseText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    aiResponse = JSON.parse(cleanedText);
                } catch (e) {
                    aiResponse = { text_response: rawAiResponseText, image_generation_prompt: null };
                }

                const aiBubble = addChatMessage(aiResponse.text_response, 'ai');
                chatHistory.push({ role: 'assistant', content: aiResponse.text_response });

                if (aiResponse.image_generation_prompt) {
                    activeImagePrompt = aiResponse.image_generation_prompt;
                    
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'chat-image-container mt-2';
                    // CHANGE 2: Indicator text converted to English
                    imageWrapper.innerHTML = `<div class="p-2 text-sm text-slate-400"><i class="fas fa-palette fa-spin mr-2"></i>Generating image...</div>`;
                    aiBubble.appendChild(imageWrapper);
                    chatMessageContainerEl.scrollTop = chatMessageContainerEl.scrollHeight;

                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(aiResponse.image_generation_prompt)}`;
                    const img = document.createElement('img');
                    img.src = imageUrl;

                    img.onload = () => {
                        imageWrapper.innerHTML = '';
                        imageWrapper.appendChild(img);

                        const openPageButton = document.createElement('button');
                        openPageButton.className = 'block w-full text-center mt-2 text-indigo-400 hover:text-indigo-300 text-sm font-semibold bg-indigo-500/10 hover:bg-indigo-500/20 py-1.5 rounded-md transition-colors';
                        // CHANGE 2: Button text converted to English
                        openPageButton.innerHTML = `<i class="fas fa-external-link-alt mr-2"></i>Open & Save`;
                        openPageButton.onclick = () => openDownloadPage(imageUrl, aiResponse.image_generation_prompt, openPageButton);
                        imageWrapper.appendChild(openPageButton);

                        chatMessageContainerEl.scrollTop = chatMessageContainerEl.scrollHeight;
                    };
                    img.onerror = () => { 
                        // CHANGE 2: Error text converted to English
                        imageWrapper.textContent = 'Sorry, the image could not be generated.'; 
                        activeImagePrompt = null; 
                    };
                }

            } catch (error) {
                console.error("Chat Error:", error);
                hideThinkingIndicator();
                // CHANGE 2: Error message converted to English
                addChatMessage(`I'm sorry, an error occurred. Please try rephrasing your request. (Error: ${error.message})`, 'ai');
            } finally {
                isProcessing = false;
            }
        }
        
        function handleFileSelection(files) {
            if (!files) return;
            for (const file of files) {
                if (stagedImages.length >= MAX_IMAGES_PER_MSG) {
                    // CHANGE 2: Alert text converted to English
                    alert(`You can only attach a maximum of ${MAX_IMAGES_PER_MSG} images.`);
                    break;
                }
                if (file.size > 4 * 1024 * 1024) {
                    // CHANGE 2: Alert text converted to English
                    alert(`Image "${file.name}" is too large (max 4MB).`);
                    continue;
                }
                const reader = new FileReader();
                reader.onloadend = () => {
                    stagedImages.push({ base64: reader.result, mime_type: file.type, name: file.name });
                    renderImagePills();
                };
                reader.readAsDataURL(file);
            }
        }

        function autoResizeTextarea() {
            chatInputEl.style.height = 'auto';
            chatInputEl.style.height = (chatInputEl.scrollHeight) + 'px';
        }

        // --- EVENT LISTENERS ---
        function init() {
            chatSendButtonEl.addEventListener('click', handleChatSubmit);
            chatInputEl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleChatSubmit();
                }
            });
            chatInputEl.addEventListener('input', autoResizeTextarea);
            attachImageButtonEl.addEventListener('click', () => imageInputEl.click());
            imageInputEl.addEventListener('change', (e) => handleFileSelection(e.target.files));
            
            initCustomScrollbar();
        }

        init();
    </script>
</body>
</html>
