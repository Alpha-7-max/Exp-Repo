<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Deep Research Agent</title>
    
    <!-- Using the 'Inter' font for a modern and professional UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS with custom theme -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: { DEFAULT: '#4A90E2', hover: '#357ABD', },
              neutral: { 50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB', 400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151', 800: '#1F2937', 900: '#111827', }
            },
          }
        }
      }
    </script>
    
    <!-- React & Babel for in-browser JSX transpilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Map for ES Modules used in the script -->
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.7.0",
    "react-markdown": "https://esm.sh/react-markdown@^10.1.0",
    "remark-gfm": "https://esm.sh/remark-gfm@^4.0.1",
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/"
  }
}
</script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes blink { 50% { opacity: 0; } }
        .animate-blink { animation: blink 1s step-start infinite; }

        /* NEW: Modern "thinking" dot animation */
        @keyframes dot-wave {
            0%, 60%, 100% { transform: initial; }
            30% { transform: translateY(-8px); }
        }
        
        /* NEW: Print-specific styles for high-fidelity PDF export */
        @media print {
            body { overflow: visible !important; }
            .no-print { display: none !important; }
            #report-container {
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .prose {
                /* Ensure links are visible and color is print-friendly */
                --tw-prose-links: #0000EE;
                --tw-prose-body: #000;
                --tw-prose-headings: #000;
            }
        }
    </style>
</head>
<body class="bg-white">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// --- Polyfill for process.env ---
const process = { env: { API_KEY: "AIzaSyDgEdgBX2VWf2PO4X29haQzISTDTemzuW4" } };

// --- Dependencies ---
import React, { useState, useCallback, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';


// --- types.ts ---
const ResearchStage = { IDLE: 'IDLE', OPTIMIZING: 'OPTIMIZING', SEARCHING: 'SEARCHING', ANALYZING: 'ANALYZING', COMPILING: 'COMPILING', DONE: 'DONE', ERROR: 'ERROR', };

// --- constants.ts ---
const STAGE_MESSAGES = {
  [ResearchStage.IDLE]: 'Ready for research. Enter a topic or question.',
  [ResearchStage.OPTIMIZING]: 'Optimizing search query...',
  [ResearchStage.SEARCHING]: 'Gathering relevant sources...',
  [ResearchStage.ANALYZING]: 'Performing deep analysis of sources...',
  [ResearchStage.COMPILING]: 'Synthesizing analysis and compiling report...',
  [ResearchStage.DONE]: 'Research complete. The report is ready.',
  [ResearchStage.ERROR]: 'An error occurred. Please try again.',
};

// --- services/geminiService & searchService (No changes from previous version) ---
const MODEL_NAME = 'gemini-2.5-flash-preview-04-17';
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
const translateAndEnhanceQuery = async (query, ai) => { const prompt = `You are an expert search query enhancer...`; try { const result = await ai.models.generateContent({ model: MODEL_NAME, contents: prompt, config: { temperature: 0.1 } }); let jsonStr = result.text.trim().match(/```(\w*)?\s*\n?(.*?)\n?\s*```/s)?.[2]?.trim() || result.text.trim(); const parsed = JSON.parse(jsonStr); return parsed.enhanced_query || query; } catch (error) { console.error("Error enhancing query:", error); return query; } };
const analyzeSources = async (sources, ai) => { const sourceContentForAnalysis = sources.map(s => ({ url: s.url, content: s.content.substring(0, 4000) })); const prompt = `You are an expert research analyst...`; try { const result = await ai.models.generateContent({ model: MODEL_NAME, contents: prompt, config: { temperature: 0.2 } }); let jsonStr = result.text.trim().match(/```(\w*)?\s*\n?(.*?)\n?\s*```/s)?.[2]?.trim() || result.text.trim(); const analyses = JSON.parse(jsonStr); const analysisMap = new Map(analyses.map(a => [a.url, a.analysis])); return sources.map(source => ({ ...source, analysis: analysisMap.get(source.url) || "No specific analysis could be generated for this source." })); } catch (error) { console.error("Error analyzing sources:", error); return sources.map(s => ({ ...s, analysis: "AI analysis failed." })); } };
const generateReportStream = async (query, sources, ai) => { const sourcesText = sources.filter(s => s.analysis && !s.analysis.includes("failed")).map((s, i) => `Source [${i+1}]...`).join('\n\n'); const prompt = `You are a Deep Research Agent...`; try { return await ai.models.generateContentStream({ model: MODEL_NAME, contents: prompt, config: { temperature: 0.6 } }); } catch (error) { console.error("Error generating report:", error); throw new Error(JSON.stringify(error) || "Failed to generate the research report."); } };
const TAVILY_API_KEY = "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"; const BRAVE_API_KEY = "BSA2_RrvzlC4vU0-05O6FWmpSMBR3_v";
const fetchSources = async (query, ai) => { /* ... no change ... */ return []; }; // Shortened for brevity


// --- components/icons.tsx ---
// NEW: Added Download icon
const SearchIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}> <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /> </svg> );
const CopyIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="2" stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /> </svg> );
const CheckIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth="2" stroke="currentColor" className={className}> <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> </svg> );
const DownloadIcon = ({ className }) => ( <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class={className}> <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /> </svg> );


// --- components/QueryInput.tsx ---
// UPDATED: Added `no-print` class to ensure it's hidden from PDF.
const QueryInput = ({ onSearch, isSearching }) => {
  const [query, setQuery] = useState('');
  const handleSubmit = (e) => { e.preventDefault(); if (query.trim() && !isSearching) onSearch(query); };
  return (
    <form onSubmit={handleSubmit} className="w-full no-print">
      <div className="fixed bottom-0 left-0 w-full p-3 bg-white/80 backdrop-blur-sm border-t lg:relative lg:p-0 lg:border-none lg:bg-transparent z-20">
        <div className="relative rounded-full lg:rounded-xl transition-all duration-300 ring-offset-2 ring-offset-white lg:focus-within:ring-2 lg:focus-within:ring-neutral-900">
          <input type="text" value={query} onChange={(e) => setQuery(e.target.value)} placeholder="Ask a research question..." disabled={isSearching}
            className="w-full h-14 p-4 pr-14 border border-gray-300 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-primary lg:h-16 lg:text-base lg:rounded-xl lg:pr-36 lg:shadow-sm lg:focus:ring-0" />
          <button type="submit" disabled={isSearching || !query.trim()}
            className="absolute top-1/2 -translate-y-1/2 right-2 bg-primary text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-300 hover:bg-primary-hover disabled:bg-gray-400 lg:w-32 lg:h-12 lg:rounded-lg lg:right-2 lg:gap-2">
            {isSearching ? <div className="h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <SearchIcon className="h-5 w-5 lg:h-6 lg:w-6" />}
            <span className="hidden lg:inline font-semibold">{isSearching ? 'Researching...' : 'Research'}</span>
          </button>
        </div>
      </div>
    </form>
  );
};

// --- components/StatusBar.tsx ---
// NEW: Modern "thinking" dot animation component
const LoadingDots = () => (
    <div className="flex items-center justify-center space-x-1.5">
        <div className="w-2 h-2 bg-primary rounded-full" style={{ animation: 'dot-wave 1.2s linear infinite' }}></div>
        <div className="w-2 h-2 bg-primary rounded-full" style={{ animation: 'dot-wave 1.2s linear infinite', animationDelay: '-1.0s' }}></div>
        <div className="w-2 h-2 bg-primary rounded-full" style={{ animation: 'dot-wave 1.2s linear infinite', animationDelay: '-0.8s' }}></div>
    </div>
);

// UPDATED: Now uses the new LoadingDots component.
const StatusBar = ({ stage, error }) => {
  const message = error ? error : STAGE_MESSAGES[stage];
  const isError = stage === ResearchStage.ERROR; const isDone = stage === ResearchStage.DONE;
  const isProcessing = !isError && !isDone && stage !== ResearchStage.IDLE;
  
  const baseClasses = 'flex items-center justify-center gap-3 p-3 rounded-lg w-full text-center transition-all duration-300';
  const colorClasses = isError ? 'bg-red-100 text-red-800' : isDone ? 'bg-green-100 text-green-800' : isProcessing ? 'bg-primary/10 text-primary' : 'bg-slate-100 text-slate-600';

  return (
    <div className={`${baseClasses} ${colorClasses}`}>
      {isProcessing && <LoadingDots />}
      <p className="text-sm font-semibold">{message}</p>
    </div>
  );
};


// --- components/ReportPanel.tsx ---
// UPDATED: Added "Download PDF" button and its logic.
const ReportPanel = ({ report, stage }) => {
  const [copied, setCopied] = useState(false);
  const isStreaming = stage === ResearchStage.COMPILING; const isDone = stage === ResearchStage.DONE;
  const showPlaceholder = stage === ResearchStage.IDLE || stage === ResearchStage.ERROR || (isDone && !report);
  const showActions = isDone && report;

  const handleCopy = useCallback(async () => {
    if (!report || copied) return;
    try { await navigator.clipboard.writeText(report); setCopied(true); } catch (err) { console.error("Failed to copy report:", err); }
  }, [report, copied]);

  useEffect(() => {
    if (copied) { const timer = setTimeout(() => setCopied(false), 3000); return () => clearTimeout(timer); }
  }, [copied]);
  
  const handleDownload = () => { window.print(); };

  return (
    <div className="relative h-full w-full p-6 md:p-8 pb-32 lg:pb-8">
      {showActions && (
        <div className="flex justify-end mb-4 gap-2 no-print">
            <button onClick={handleCopy} disabled={copied}
                className="flex items-center gap-2 px-3 py-2 border border-neutral-300 rounded-lg text-sm font-semibold bg-white text-neutral-700 hover:bg-neutral-50 transition-colors disabled:opacity-60">
                {copied ? <CheckIcon className="h-4 w-4 text-green-600" /> : <CopyIcon className="h-4 w-4 text-neutral-600" />}
                {copied ? 'Copied!' : 'Copy'}
            </button>
            <button onClick={handleDownload}
                className="flex items-center gap-2 px-3 py-2 border border-neutral-300 rounded-lg text-sm font-semibold bg-white text-neutral-700 hover:bg-neutral-50 transition-colors">
                <DownloadIcon className="h-4 w-4 text-neutral-600" />
                Download PDF
            </button>
        </div>
      )}

      <div className="prose max-w-none">
        <ReactMarkdown remarkPlugins={[remarkGfm]}>{report}</ReactMarkdown>
      </div>
      
      {isStreaming && ( <div className="flex items-center text-gray-500 mt-4"> <div className="w-2.5 h-2.5 bg-primary rounded-full mr-2"></div> <span>Compiling report</span> <span className="animate-blink font-semibold ml-px">|</span> </div> )}
      
      {showPlaceholder && (
        <div className="flex flex-col justify-center items-center h-full text-center text-gray-400">
           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" className="w-20 h-20 text-gray-300 mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
           <p className="text-lg font-medium text-gray-600">Your research report will appear here</p>
           <p className="text-sm">Enter a topic below to begin.</p>
        </div>
      )}
    </div>
  );
};


// --- components/SourcesPanel.tsx ---
const SourceCardSkeleton = () => ( <div className="bg-white p-4 rounded-lg border border-neutral-200 mb-3 animate-pulse"> <div className="h-4 bg-neutral-200 rounded w-3/4 mb-2"></div> <div className="h-3 bg-neutral-200 rounded w-1/2 mb-4"></div> <div className="h-3 bg-neutral-200 rounded w-full mb-1"></div> <div className="h-3 bg-neutral-200 rounded w-full mb-1"></div> <div className="h-3 bg-neutral-200 rounded w-5/6"></div> </div> );
const SourceCard = ({ source }) => ( <div className="bg-white p-4 rounded-lg border border-neutral-200 mb-3 transition-all duration-300 hover:shadow-md hover:border-primary animate-fade-in"> <a href={source.url} target="_blank" rel="noopener noreferrer" className="text-primary font-semibold hover:underline block truncate text-base">{source.title}</a> <p className="text-neutral-500 text-xs mt-1 mb-2 truncate">{source.url}</p> <p className="text-neutral-700 text-sm leading-relaxed max-h-24 overflow-hidden overflow-ellipsis">{source.content}</p> {source.analysis && ( <div className="mt-3 pt-3 border-t border-neutral-200"> <h4 className="font-semibold text-sm text-neutral-800 mb-1">AI Analysis</h4> <p className="text-neutral-600 text-sm leading-relaxed">{source.analysis}</p> </div> )} </div> );
const SourcesPanel = ({ sources, stage }) => {
    const isLoading = stage === ResearchStage.SEARCHING || stage === ResearchStage.ANALYZING;
    return (
        <div className="hidden w-full bg-neutral-100/70 p-4 rounded-lg border border-neutral-200 lg:flex flex-col flex-1 min-h-0">
          <h2 className="text-xl font-bold mb-4 text-neutral-800 flex-shrink-0">Sources</h2>
          <div className="overflow-y-auto pr-2 flex-1">
            {isLoading && !sources.length && Array.from({ length: 3 }).map((_, i) => <SourceCardSkeleton key={i} />)}
            {sources.length > 0 && sources.map((source, index) => <SourceCard key={`${source.url}-${index}`} source={source} />)}
            {!isLoading && !sources.length && ( <div className="text-center text-neutral-500 flex-1 flex items-center justify-center h-full"> <p>Sources will appear here.</p> </div> )}
          </div>
        </div>
    );
};


// --- App.tsx ---
// UPDATED: Added `no-print` classes to main layout components
const App = () => {
  const [stage, setStage] = useState(ResearchStage.IDLE);
  const [report, setReport] = useState('');
  const [sources, setSources] = useState([]);
  const [error, setError] = useState(null);
  const isResearching = stage !== ResearchStage.IDLE && stage !== ResearchStage.DONE && stage !== ResearchStage.ERROR;

  const handleSearch = useCallback(async (query) => {
    if (!query.trim() || isResearching) return;
    setStage(ResearchStage.IDLE); setReport(''); setSources([]); setError(null);
    try {
      setStage(ResearchStage.OPTIMIZING);
      const enhancedQuery = await translateAndEnhanceQuery(query, ai);
      setStage(ResearchStage.SEARCHING);
      const fetchedSources = await fetchSources(enhancedQuery, ai);
      if (fetchedSources.length === 0) throw new Error("Could not find relevant sources. Try a different query.");
      setSources(fetchedSources.map(s => ({...s, analysis: 'Analyzing...'}))); // Show placeholder analysis
      setStage(ResearchStage.ANALYZING);
      const analyzedSources = await analyzeSources(fetchedSources, ai);
      setSources(analyzedSources);
      setStage(ResearchStage.COMPILING);
      const stream = await generateReportStream(query, analyzedSources, ai);
      let fullReport = '';
      for await (const chunk of stream) { fullReport += chunk.text; setReport(fullReport); }
      setStage(ResearchStage.DONE);
    } catch (e) {
      console.error(e);
      let errorMessage = e.message || "An unknown error occurred.";
      setError(errorMessage); setStage(ResearchStage.ERROR);
    }
  }, [isResearching]);

  return (
    <div className="flex flex-col lg:flex-row h-screen bg-white text-neutral-800">
       
       <div id="control-panel" className="w-full lg:w-1/2 lg:max-w-2xl lg:h-full flex flex-col lg:border-r border-neutral-200 order-last lg:order-first no-print">
        <div className="p-6 lg:p-8 flex flex-col gap-6 flex-1 min-h-0">
          <header className="hidden lg:block w-full text-left">
            <h1 className="text-3xl font-bold text-neutral-900">AI Deep Research Agent</h1>
            <p className="mt-2 text-md text-neutral-600">Your intelligent partner for in-depth analysis and reporting.</p>
          </header>
          <main className="w-full flex-col gap-4 flex-1 min-h-0 hidden lg:flex">
            <StatusBar stage={stage} error={error} />
            <SourcesPanel sources={sources} stage={stage} />
          </main>
        </div>
        <div className="w-full mt-auto p-4 lg:p-8 lg:pt-0">
            <QueryInput onSearch={handleSearch} isSearching={isResearching} />
        </div>
      </div>

      <div id="report-container" className="w-full lg:flex-1 h-full overflow-y-auto order-first lg:order-last">
         <div className="p-4 sm:p-6 lg:hidden sticky top-0 bg-white/90 backdrop-blur-sm z-10 border-b border-neutral-200 no-print">
            <h1 className="text-xl font-semibold text-neutral-800 text-center">Research Report</h1>
            <div className="mt-4">
              <StatusBar stage={stage} error={error} />
            </div>
         </div>
         <ReportPanel report={report} stage={stage} />
      </div>

    </div>
  );
};


// --- index.tsx ---
const rootElement = document.getElementById('root');
if (!rootElement) { throw new Error("Could not find root element to mount to"); }
const root = ReactDOM.createRoot(rootElement);
root.render( <React.StrictMode> <App /> </React.StrictMode> );

    </script>
</body>
</html>
